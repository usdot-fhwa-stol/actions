name: 'C++ Sonar Scanner'
description: 'Scan a C++ project and push to Sonar Cloud'
inputs:
  build-wrapper-out-dir:
    description: 'Build wrapper output directory'
    required: false
    default: 'bw_output'
runs:
  using: 'composite'
  steps:
    - name: Install curl, zip, git, gcovr
      shell: bash
      run: |
        apt update
        export DEBIAN_FRONTEND=noninteractive
        apt-get install -y curl zip git gcovr
    - uses: actions/checkout@v3
      with:
        # Disabling shallow clone is recommended for improving relevancy of reporting
        fetch-depth: 0
    - name:  Install sonar-scanner and build-wrapper
      uses: sonarsource/sonarcloud-github-c-cpp@v1
    - name: Run build-wrapper
      shell: bash
      # here goes your compilation wrapped with build-wrapper; See https://docs.sonarcloud.io/advanced-setup/languages/c-c-objective-c/#analysis-steps-using-build-wrapper for more information
      run: |
        # build-preparation steps
        if [ -f install_dependencies.sh ]; then
          ./install_dependencies.sh
        fi
        build-wrapper-linux-x86-64 --out-dir ${{ inputs.build-wrapper-out-dir }} bash ./build.sh -c
        # check for coverage in expected location
        ls -al build/coverage_sonar.xml
    - name: Run sonar-scanner
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      shell: bash
      run: sonar-scanner --define sonar.cfamily.build-wrapper-output="${{ inputs.build-wrapper-out-dir }}" #Consult https://docs.sonarcloud.io/advanced-setup/ci-based-analysis/sonarscanner-cli/ for more information and options
